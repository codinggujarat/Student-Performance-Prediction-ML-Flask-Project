{% extends "layout.html" %}
{% block content %}
<div class="p-6 space-y-6">

    <!-- Page Title -->
    <div class="bg-white/5 backdrop-blur-xl border border-white/10 shadow-2xl rounded-2xl p-6 text-center">
        <h2 class="text-4xl sm:text-5xl md:text-4xl font-bold uppercase text-center text-white mb-6"
            style="font-family: 'Panchang', sans-serif; font-weight: bolder !important;">
            Model Performance Report</h1>
            <p class="text-gray-300 mt-2 text-sm" style="font-weight: lighter;">
                Latest results file: <span class="font-semibold text-white" style="font-family: 'General Sans', sans-serif; font-weight: lighter;">{{ file_name }}</span>
            </p>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Score Distribution -->
        <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl p-5">
            <h3 class="text-lg font-semibold text-cyan-400 text-center mb-4">Predicted Score Distribution</h3>
            <canvas id="scoreChart" class="w-full h-72"></canvas>
        </div>

        <!-- High vs Low Risk -->
        <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl p-5">
            <h3 class="text-lg font-semibold text-cyan-400 text-center mb-4">High vs Low Risk</h3>
            <canvas id="riskChart" class="w-full h-72"></canvas>
        </div>

        {% if show_semester_charts %}
        <!-- Avg Score per Semester -->
        <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl p-5">
            <h3 class="text-lg font-semibold text-cyan-400 text-center mb-4">Average Score per Semester</h3>
            <canvas id="avgScoreChart" class="w-full h-72"></canvas>
        </div>

        <!-- High vs Low Risk per Semester -->
        <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl p-5">
            <h3 class="text-lg font-semibold text-cyan-400 text-center mb-4">High vs Low Risk per Semester</h3>
            <canvas id="stackedChart" class="w-full h-72"></canvas>
        </div>
        {% else %}
        <!-- No Semester Data -->
        <div
            class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl p-5 flex items-center justify-center">
            <p class="text-gray-400 text-center">⚠ Semester data not available in the latest results file.</p>
        </div>
        <div
            class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl p-5 flex items-center justify-center">
            <p class="text-gray-400 text-center">⚠ Semester data not available in the latest results file.</p>
        </div>
        {% endif %}

    </div>

    <!-- Back Button -->
    <div class="text-center mt-6">
        <a href="/" class="px-5 py-3 rounded-full bg-purple-500/20 text-white font-light shadow-lg text-sm
                       hover:to-indigo-700 
                                           transition duration-300 ease-in-out"
            style="letter-spacing: 2px; font-family: 'General Sans', sans-serif;"> Back to Dashboard
        </a>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const scores = {{ scores | tojson }};
    const riskCounts = {{ risk_counts | tojson }};
    const showSemester = {{ show_semester_charts | tojson }};
    const semesters = {{ semesters | tojson }};
    const avgScores = {{ avg_scores_list | tojson }};
    const highCounts = {{ high_counts | tojson }};
    const lowCounts = {{ low_counts | tojson }};

    function binScores(arr, size = 10) {
        const bins = {};
        arr.forEach(v => {
            const bucket = Math.floor(v / size) * size;
            bins[bucket] = (bins[bucket] || 0) + 1;
        });
        const keys = Object.keys(bins).map(Number).sort((a, b) => a - b);
        return {
            labels: keys.map(k => `${k}-${k + size - 1}`),
            values: keys.map(k => bins[k])
        };
    }

    const binned = binScores(scores, 10);
    new Chart(document.getElementById("scoreChart"), {
        type: "bar",
        data: {
            labels: binned.labels,
            datasets: [{
                label: "Students",
                data: binned.values,
                backgroundColor: "#34d399"
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: "#d1d5db" } },
                y: { ticks: { color: "#d1d5db" } }
            }
        }
    });

    new Chart(document.getElementById("riskChart"), {
        type: "doughnut",
        data: {
            labels: Object.keys(riskCounts),
            datasets: [{
                data: Object.values(riskCounts),
                backgroundColor: ["#f87171", "#34d399"]
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: "#e5e7eb" } } }
        }
    });

    if (showSemester) {
        new Chart(document.getElementById("avgScoreChart"), {
            type: "line",
            data: {
                labels: semesters,
                datasets: [{
                    label: "Avg Score",
                    data: avgScores,
                    borderColor: "#60a5fa",
                    backgroundColor: "rgba(96,165,250,0.2)",
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: "#e5e7eb" } } }
            }
        });

        new Chart(document.getElementById("stackedChart"), {
            type: "bar",
            data: {
                labels: semesters,
                datasets: [
                    { label: "High", data: highCounts, backgroundColor: "#f87171" },
                    { label: "Low", data: lowCounts, backgroundColor: "#34d399" }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: "#e5e7eb" } } },
                scales: {
                    x: { stacked: true, ticks: { color: "#d1d5db" } },
                    y: { stacked: true, ticks: { color: "#d1d5db" } }
                }
            }
        });
    }
</script>
{% endblock %}