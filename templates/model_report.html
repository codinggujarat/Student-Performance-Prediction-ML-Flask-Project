{% extends "layout.html" %}
{% block content %}
<!-- Left Container -->
<div class="max-w-10xl bg-transparent text-left space-y-6">

    <!-- Page Title -->
    <div class="bg-white/5  bg-[#1C1C1C] rounded-2xl p-6 text-center">
        <h2 class="text-4xl sm:text-5xl md:text-5xl  text-center font-extrabold capitalize bg-gradient-to-r from-white to-white/50 bg-clip-text text-transparent"
            style="letter-spacing: 2px; font-family: 'Clash Grotesk', sans-serif; font-weight: normal !important;">
            Model Performance Report</h1>
            <p class="text-gray-300 mt-2 text-sm" style="font-weight: lighter;">
                Latest results file: <span class="font-normal text-white"
                    style="font-family: 'General Sans', sans-serif; font-weight: lighter;">{{ file_name }}</span>
            </p>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Score Distribution -->
        <div class="bg-white/5  bg-[#1C1C1C] rounded-2xl rounded-2xl shadow-2xl p-5">
            <h3 class="text-lg font-normal text-white text-start mb-4  flex items-center gap-2 ">
                <span class="bg-[#393939] p-2 rounded-lg w-10 h-10 flex items-center justify-center">
                    <i class='bx bx-bar-chart-alt-2'></i>
                </span>
                Predicted Score Distribution
            </h3>
            <canvas id="scoreChart" class="w-full h-100"></canvas>
        </div>

        <!-- High vs Low Risk -->
        <div class="bg-white/5  bg-[#1C1C1C] rounded-2xl rounded-2xl shadow-2xl p-5">
            <h3 class="text-lg font-normal text-white text-start mb-4  flex items-center gap-2 ">
                <span class="bg-[#393939] p-2 rounded-lg w-10 h-10 flex items-center justify-center">
                    <i class='bx bx-pie-chart-alt'></i>
                </span>
                High vs Low Risk
            </h3>
            <canvas id="riskChart" class="w-full h-100"></canvas>
        </div>

        {% if show_semester_charts %}
        <!-- Avg Score per Semester -->
        <div class="bg-white/5  bg-[#1C1C1C] rounded-2xl rounded-2xl shadow-2xl p-5">
            <h3 class="text-lg font-normal text-white text-start mb-4  flex items-center gap-2 ">
                <span class="bg-[#393939] p-2 rounded-lg w-10 h-10 flex items-center justify-center">
                    <i class='bx bx-line-chart'></i>
                </span>

                Average Score per Semester
            </h3>
            <canvas id="avgScoreChart" class="w-full h-100"></canvas>
        </div>

        <!-- High vs Low Risk per Semester -->
        <div class="bg-white/5  bg-[#1C1C1C] rounded-2xl rounded-2xl shadow-2xl p-5">
            <h3 class="text-lg font-normal text-white text-start mb-4 flex items-center gap-2">
                <span class="bg-[#393939] p-2 rounded-lg w-10 h-10 flex items-center ">
                    <i class='bx bx-bar-chart-alt-2'></i>
                </span>
                High vs Low Risk per Semester
            </h3>
            <canvas id="stackedChart" class="w-full h-100"></canvas>
        </div>
        {% else %}
        <!-- No Semester Data -->
        <div class="bg-white/5  bg-[#1C1C1C] rounded-2xl rounded-2xl shadow-2xl p-5 flex items-center justify-center">
            <p class="text-gray-400 text-center">⚠ Semester data not available in the latest results file.</p>
        </div>
        <div class="bg-white/5  bg-[#1C1C1C] rounded-2xl rounded-2xl shadow-2xl p-5 flex items-center justify-center">
            <p class="text-gray-400 text-center">⚠ Semester data not available in the latest results file.</p>
        </div>
        {% endif %}

    </div>

    <!-- Back Button -->
    <a href="{{ url_for('index') }}" class="flex items-center gap-2 px-5 py-3 rounded-xl text-white font-light shadow-lg text-sm
                       hover:text-gray-300 transition duration-300 ease-in-out  bg-[#1C1C1C]"
        style="letter-spacing: 2px; font-family: 'General Sans', sans-serif; ">
        <span class="bg-[#393939] px-3  py-2 rounded-lg  flex items-center">
            <i class='bx bx-left-arrow-alt text-lg'></i>
        </span>
        Back to Home
    </a>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const scores = {{ scores | tojson }};
    const riskCounts = {{ risk_counts | tojson }};
    const showSemester = {{ show_semester_charts | tojson }};
    const semesters = {{ semesters | tojson }};
    const avgScores = {{ avg_scores_list | tojson }};
    const highCounts = {{ high_counts | tojson }};
    const lowCounts = {{ low_counts | tojson }};

    function binScores(arr, size = 10) {
        const bins = {};
        arr.forEach(v => {
            const bucket = Math.floor(v / size) * size;
            bins[bucket] = (bins[bucket] || 0) + 1;
        });
        const keys = Object.keys(bins).map(Number).sort((a, b) => a - b);
        return {
            labels: keys.map(k => `${k}-${k + size - 1}`),
            values: keys.map(k => bins[k])
        };
    }

    const binned = binScores(scores, 10);
    new Chart(document.getElementById("scoreChart"), {
        type: "bar",
        data: {
            labels: binned.labels,
            datasets: [{
                label: "Students",
                data: binned.values,
                backgroundColor: "rgba(99,102,241,0.4)" // Indigo transparent
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: "#e5e7eb" } },
                y: { ticks: { color: "#e5e7eb" } }
            }
        }
    });

    new Chart(document.getElementById("riskChart"), {
        type: "doughnut",
        data: {
            labels: Object.keys(riskCounts),
            datasets: [{
                data: Object.values(riskCounts),
                backgroundColor: [
                    "rgba(248,113,113,0.6)", // Red transparent
                    "rgba(139,92,246,0.6)"   // Purple transparent
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: "#e5e7eb" } } }
        }
    });

    if (showSemester) {
        new Chart(document.getElementById("avgScoreChart"), {
            type: "line",
            data: {
                labels: semesters,
                datasets: [{
                    label: "Avg Score",
                    data: avgScores,
                    borderColor: "rgba(99,102,241,1)", // Indigo solid line
                    backgroundColor: "rgba(99,102,241,0.2)", // Indigo transparent fill
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: "#e5e7eb" } } }
            }
        });

        new Chart(document.getElementById("stackedChart"), {
            type: "bar",
            data: {
                labels: semesters,
                datasets: [
                    { label: "High", data: highCounts, backgroundColor: "rgba(248,113,113,0.6)" }, // Red transparent
                    { label: "Low", data: lowCounts, backgroundColor: "rgba(139,92,246,0.6)" }     // Purple transparent
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: "#e5e7eb" } } },
                scales: {
                    x: { stacked: true, ticks: { color: "#e5e7eb" } },
                    y: { stacked: true, ticks: { color: "#e5e7eb" } }
                }
            }
        });
    }
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false, // Important: allow fixed canvas height
        plugins: { legend: { labels: { color: "#e5e7eb" } } },
        scales: {
            x: { ticks: { color: "#e5e7eb" } },
            y: { ticks: { color: "#e5e7eb" } }
        }
    };

    // Score Distribution
    new Chart(document.getElementById("scoreChart"), {
        type: "bar",
        data: {
            labels: binned.labels,
            datasets: [{
                label: "Students",
                data: binned.values,
                backgroundColor: "rgba(99,102,241,0.4)" // Indigo transparent
            }]
        },
        options: chartOptions
    });

    // Risk Chart
    new Chart(document.getElementById("riskChart"), {
        type: "doughnut",
        data: {
            labels: Object.keys(riskCounts),
            datasets: [{
                data: Object.values(riskCounts),
                backgroundColor: ["rgba(248,113,113,0.6)", "rgba(139,92,246,0.6)"]
            }]
        },
        options: chartOptions
    });

    // Semester Charts
    if (showSemester) {
        new Chart(document.getElementById("avgScoreChart"), {
            type: "line",
            data: {
                labels: semesters,
                datasets: [{
                    label: "Avg Score",
                    data: avgScores,
                    borderColor: "rgba(99,102,241,1)",
                    backgroundColor: "rgba(99,102,241,0.2)",
                    fill: true
                }]
            },
            options: chartOptions
        });

        new Chart(document.getElementById("stackedChart"), {
            type: "bar",
            data: {
                labels: semesters,
                datasets: [
                    { label: "High", data: highCounts, backgroundColor: "rgba(248,113,113,0.6)" },
                    { label: "Low", data: lowCounts, backgroundColor: "rgba(139,92,246,0.6)" }
                ]
            },
            options: { ...chartOptions, scales: { x: { stacked: true, ticks: { color: "#e5e7eb" } }, y: { stacked: true, ticks: { color: "#e5e7eb" } } } }
        });
    }

</script>

{% endblock %}